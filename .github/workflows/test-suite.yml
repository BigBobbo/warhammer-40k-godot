name: Automated Test Suite

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  GODOT_VERSION: "4.4.1"

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run GUT Test Suite
    timeout-minutes: 15

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v2
      with:
        version: ${{ env.GODOT_VERSION }}
        use-dotnet: false

    - name: Verify Godot installation
      run: godot --version

    - name: Import project
      run: |
        cd 40k
        timeout 120 godot --headless --import || true

    - name: Run Unit Tests
      run: |
        cd 40k
        timeout 180 godot --headless --script addons/gut/gut_cmdln.gd \
          -gdir=res://tests/unit -glog=2 \
          -gjunit_xml_file=unit_test_results.xml \
          -gexit || true

    - name: Run Integration Tests
      run: |
        cd 40k
        timeout 180 godot --headless --script addons/gut/gut_cmdln.gd \
          -gdir=res://tests/integration -glog=2 \
          -gjunit_xml_file=integration_test_results.xml \
          -gexit || true

    - name: Run Network Tests
      run: |
        cd 40k
        timeout 180 godot --headless --script addons/gut/gut_cmdln.gd \
          -gdir=res://tests/network -glog=2 \
          -gjunit_xml_file=network_test_results.xml \
          -gexit || true

    - name: Run All Tests Combined
      run: |
        cd 40k
        timeout 300 godot --headless --script addons/gut/gut_cmdln.gd \
          -glog=1 \
          -gjunit_xml_file=all_test_results.xml \
          -gexit
      continue-on-error: true

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          40k/*_test_results.xml

    - name: Check for test failures
      if: always()
      run: |
        cd 40k
        echo "--- Test Result Files ---"
        ls -la *_test_results.xml 2>/dev/null || echo "No result files found"

        # Check combined results first
        if [ -f "all_test_results.xml" ]; then
          failures=$(grep -o 'failures="[0-9]*"' all_test_results.xml | grep -o '[0-9]*' | awk '{s+=$1} END {print s+0}')
          errors=$(grep -o 'errors="[0-9]*"' all_test_results.xml | grep -o '[0-9]*' | awk '{s+=$1} END {print s+0}')
          tests=$(grep -o 'tests="[0-9]*"' all_test_results.xml | grep -o '[0-9]*' | awk '{s+=$1} END {print s+0}')

          echo "Total tests: $tests"
          echo "Failures: $failures"
          echo "Errors: $errors"

          if [ "$failures" -gt 0 ] || [ "$errors" -gt 0 ]; then
            echo "::warning::Tests had $failures failures and $errors errors out of $tests tests"
          else
            echo "All $tests tests passed!"
          fi
        else
          echo "::warning::Combined test results file not generated"
        fi

  build-verification:
    runs-on: ubuntu-latest
    name: Build Verification
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    timeout-minutes: 10

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v2
      with:
        version: ${{ env.GODOT_VERSION }}
        use-dotnet: false

    - name: Import project
      run: |
        cd 40k
        timeout 120 godot --headless --import || true

    - name: Export project (Linux/X11)
      run: |
        cd 40k
        mkdir -p build/linux
        timeout 180 godot --headless --export-release "Linux/X11" build/linux/40k-game.x86_64
      continue-on-error: true

    - name: Verify build artifacts
      run: |
        cd 40k
        if [ -f "build/linux/40k-game.x86_64" ]; then
          echo "Linux build successful"
          ls -la build/linux/
        else
          echo "::warning::Linux build did not produce artifacts (export templates may not be configured)"
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: linux-build
        path: 40k/build/linux/

  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Checks
    timeout-minutes: 10

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Verify project structure
      run: |
        cd 40k
        echo "--- Project Structure Check ---"
        [ -d "tests" ] || { echo "::error::tests directory missing"; exit 1; }
        [ -d "addons/gut" ] || { echo "::error::GUT addon missing"; exit 1; }
        [ -f "project.godot" ] || { echo "::error::project.godot missing"; exit 1; }
        [ -f ".gutconfig.json" ] || { echo "::error::GUT config missing"; exit 1; }
        echo "Project structure validated"

    - name: Count test files
      run: |
        cd 40k
        unit_tests=$(find tests/unit -name "test_*.gd" 2>/dev/null | wc -l | tr -d ' ')
        integration_tests=$(find tests/integration -name "test_*.gd" 2>/dev/null | wc -l | tr -d ' ')
        network_tests=$(find tests/network -name "test_*.gd" 2>/dev/null | wc -l | tr -d ' ')
        total_tests=$((unit_tests + integration_tests + network_tests))

        echo "Test file counts:"
        echo "  Unit tests: $unit_tests"
        echo "  Integration tests: $integration_tests"
        echo "  Network tests: $network_tests"
        echo "  Total test files: $total_tests"

        [ $total_tests -ge 5 ] || { echo "::error::Insufficient test coverage ($total_tests files)"; exit 1; }
        echo "Test coverage validation passed"

  notification:
    runs-on: ubuntu-latest
    name: Test Results Notification
    needs: [test, code-quality]
    if: always()

    steps:
    - name: Create summary
      run: |
        echo "## Automated Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Job Results:" >> $GITHUB_STEP_SUMMARY
        echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "For detailed results, check the individual job logs and artifacts." >> $GITHUB_STEP_SUMMARY
