# GitHub Actions workflow to build and deploy web export to itch.io
name: Deploy Web Build

on:
  push:
    branches:
      - main
    paths:
      - '40k/**'
      - '.github/workflows/deploy-web.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  GODOT_VERSION: "4.4.1"
  EXPORT_NAME: "Warhammer40K"
  ITCH_USERNAME: "oisinrob"
  ITCH_GAME: "warhammer40k-simulator"  # Update with actual itch.io game name

jobs:
  # First run tests
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false

      - name: Run GUT Tests
        run: |
          cd 40k
          godot --headless --script res://addons/gut/gut_cmdln.gd -gdir=res://tests/ -gprefix=test_ -gsuffix=.gd -gexit || true
        continue-on-error: true  # Don't fail deployment on test failures for now

  # Build web export
  build-web:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          export-templates: false

      - name: Download Export Templates
        run: |
          mkdir -p ~/.local/share/godot/export_templates/${{ env.GODOT_VERSION }}.stable
          cd ~/.local/share/godot/export_templates/${{ env.GODOT_VERSION }}.stable
          wget -q https://github.com/godotengine/godot/releases/download/${{ env.GODOT_VERSION }}-stable/Godot_v${{ env.GODOT_VERSION }}-stable_export_templates.tpz
          unzip -q Godot_v${{ env.GODOT_VERSION }}-stable_export_templates.tpz
          mv templates/* .
          rmdir templates
          rm Godot_v${{ env.GODOT_VERSION }}-stable_export_templates.tpz
          ls -la

      - name: Create server config for web
        run: |
          # Create server config with production URL
          echo '{"server_url": "${{ secrets.WS_SERVER_URL }}"}' > 40k/server_config.local.json

      - name: Import project assets
        run: |
          cd 40k
          godot --headless --import --quit || true

      - name: Export for Web
        run: |
          cd 40k
          mkdir -p exports/web
          godot --headless --path . --export-release "Web" exports/web/index.html

      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: 40k/exports/web/
          retention-days: 7

  # Deploy to itch.io
  deploy-itch:
    runs-on: ubuntu-latest
    needs: build-web
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Download Web Artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web-build

      - name: Install and Run Butler
        uses: robpc/itchio-upload-action@v2
        with:
          path: web-build
          project: ${{ env.ITCH_USERNAME }}/${{ env.ITCH_GAME }}
          channel: html5
          api-key: ${{ secrets.ITCH_BUTLER_KEY }}

      - name: Deployment Summary
        run: |
          echo "## Web Build Deployed to itch.io" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Game: ${{ env.ITCH_GAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- Channel: html5" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
